# pyMediaTools è·¨å¹³å°è‡ªåŠ¨æ‰“åŒ…
# è§¦å‘æ¡ä»¶ï¼šæ¨é€ tag (å¦‚ v2.1.0) æˆ–æ‰‹åŠ¨è§¦å‘

name: ğŸš€ Build All Platforms

on:
  # æ¨é€ç‰ˆæœ¬æ ‡ç­¾æ—¶è‡ªåŠ¨è§¦å‘
  push:
    tags:
      - 'v*'
  
  # æ‰‹åŠ¨è§¦å‘ï¼ˆåœ¨ GitHub é¡µé¢ç‚¹å‡» Run workflowï¼‰
  workflow_dispatch:
    inputs:
      version:
        description: 'ç‰ˆæœ¬å· (å¦‚ 2.1.0)'
        required: false
        default: 'dev'

# å¹¶å‘æ§åˆ¶ï¼šåŒä¸€åˆ†æ”¯åªè¿è¡Œä¸€ä¸ªå·¥ä½œæµ
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # ==================== macOS æ‰“åŒ… ====================
  build-mac:
    name: ğŸ macOS (Intel + Apple Silicon)
    runs-on: macos-latest
    
    steps:
      - name: ğŸ“¥ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
      
      - name: ğŸ“¦ è®¾ç½® Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      - name: ğŸ”§ å®‰è£…ä¾èµ–
        run: npm ci
      
      - name: ğŸ—ï¸ æ„å»ºå‰ç«¯
        run: npm run build
      
      - name: ğŸ“¦ æ‰“åŒ… macOS (ARM64 + x64)
        run: npx electron-builder --mac --arm64 --x64
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: ğŸ“¤ ä¸Šä¼  macOS äº§ç‰©
        uses: actions/upload-artifact@v4
        with:
          name: macos-builds
          path: |
            dist-electron/*.dmg
            dist-electron/*.zip
          retention-days: 30

  # ==================== Windows æ‰“åŒ… ====================
  build-windows:
    name: ğŸªŸ Windows (x64)
    runs-on: windows-latest
    
    steps:
      - name: ğŸ“¥ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
      
      - name: ğŸ“¦ è®¾ç½® Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      - name: ğŸ”§ å®‰è£…ä¾èµ–
        run: npm ci
      
      - name: ğŸ—ï¸ æ„å»ºå‰ç«¯
        run: npm run build
      
      - name: ğŸ“¦ æ‰“åŒ… Windows x64
        run: npx electron-builder --win --x64
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: ğŸ“¤ ä¸Šä¼  Windows äº§ç‰©
        uses: actions/upload-artifact@v4
        with:
          name: windows-builds
          path: |
            dist-electron/*.zip
            dist-electron/*.exe
          retention-days: 30

  # ==================== Linux æ‰“åŒ… ====================
  build-linux:
    name: ğŸ§ Linux (x64)
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
      
      - name: ğŸ“¦ è®¾ç½® Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      - name: ğŸ”§ å®‰è£…ä¾èµ–
        run: npm ci
      
      - name: ğŸ—ï¸ æ„å»ºå‰ç«¯
        run: npm run build
      
      - name: ğŸ“¦ æ‰“åŒ… Linux x64
        run: npx electron-builder --linux --x64
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: ğŸ“¤ ä¸Šä¼  Linux äº§ç‰©
        uses: actions/upload-artifact@v4
        with:
          name: linux-builds
          path: |
            dist-electron/*.AppImage
            dist-electron/*.deb
          retention-days: 30

  # ==================== åˆ›å»º Release ====================
  create-release:
    name: ğŸ“¢ åˆ›å»º GitHub Release
    needs: [build-mac, build-windows, build-linux]
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v')
    
    steps:
      - name: ğŸ“¥ ä¸‹è½½æ‰€æœ‰äº§ç‰©
        uses: actions/download-artifact@v4
        with:
          path: all-builds
          merge-multiple: true
      
      - name: ğŸ“‹ åˆ—å‡ºæ–‡ä»¶
        run: ls -la all-builds/
      
      - name: ğŸ‰ åˆ›å»º Release
        uses: softprops/action-gh-release@v1
        with:
          files: all-builds/*
          draft: true
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
