# pyMediaTools è·¨å¹³å°è‡ªåŠ¨æ‰“åŒ…
# è§¦å‘æ¡ä»¶ï¼šæ¨é€ tag (å¦‚ v2.1.0) æˆ–æ‰‹åŠ¨è§¦å‘

name: ğŸš€ Build All Platforms

on:
  push:
    tags:
      - 'v*'
  
  workflow_dispatch:
    inputs:
      version:
        description: 'ç‰ˆæœ¬å· (å¦‚ 2.1.0)'
        required: false
        default: 'dev'

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  PYTHON_EMBED_VERSION: "3.11.9"
  FFMPEG_VERSION: "7.1"

jobs:
  # ==================== macOS æ‰“åŒ… ====================
  build-mac:
    name: ğŸ macOS (Intel + Apple Silicon)
    runs-on: macos-latest
    
    steps:
      - name: ğŸ“¥ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
      
      - name: ğŸ“¦ è®¾ç½® Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      - name: ğŸ è®¾ç½® Python (ç”¨äºåç«¯ä¾èµ–éªŒè¯)
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: ğŸ”§ å®‰è£… Python ä¾èµ–
        run: |
          pip install flask flask-cors pydub requests pysrt diff-match-patch
      
      - name: ğŸ“¥ ä¸‹è½½ FFmpeg (macOS)
        run: |
          mkdir -p vendor/darwin/ffmpeg/bin
          # ä½¿ç”¨ Homebrew å®‰è£…çš„ ffmpeg è·¯å¾„
          brew install ffmpeg
          cp $(which ffmpeg) vendor/darwin/ffmpeg/bin/
          cp $(which ffprobe) vendor/darwin/ffmpeg/bin/
          chmod +x vendor/darwin/ffmpeg/bin/*
          echo "âœ… FFmpeg å·²å®‰è£…åˆ° vendor/darwin/ffmpeg/bin/"
          ls -la vendor/darwin/ffmpeg/bin/
      
      - name: ğŸ”§ å®‰è£… Node ä¾èµ–
        run: npm ci
      
      - name: ğŸ—ï¸ æ„å»ºå‰ç«¯
        run: npm run build
      
      - name: ğŸ“¦ æ‰“åŒ… macOS (ARM64 + x64)
        run: npx electron-builder --mac --arm64 --x64
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: ğŸ“¤ ä¸Šä¼  macOS äº§ç‰©
        uses: actions/upload-artifact@v4
        with:
          name: macos-builds
          path: |
            dist-electron/*.dmg
            dist-electron/*.zip
          retention-days: 30

  # ==================== Windows æ‰“åŒ… ====================
  build-windows:
    name: ğŸªŸ Windows (x64)
    runs-on: windows-latest
    
    steps:
      - name: ğŸ“¥ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
      
      - name: ğŸ“¦ è®¾ç½® Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      - name: ğŸ ä¸‹è½½ Python Embedded
        shell: pwsh
        run: |
          $pythonUrl = "https://www.python.org/ftp/python/${{ env.PYTHON_EMBED_VERSION }}/python-${{ env.PYTHON_EMBED_VERSION }}-embed-amd64.zip"
          $pythonZip = "python-embed.zip"
          
          Write-Host "ğŸ“¥ ä¸‹è½½ Python Embedded from $pythonUrl"
          Invoke-WebRequest -Uri $pythonUrl -OutFile $pythonZip
          
          # åˆ›å»ºç›®å½•å¹¶è§£å‹
          New-Item -ItemType Directory -Force -Path "vendor/windows/python"
          Expand-Archive -Path $pythonZip -DestinationPath "vendor/windows/python" -Force
          Remove-Item $pythonZip
          
          # ä¿®æ”¹ python311._pth å¯ç”¨ site-packages
          $pthFile = "vendor/windows/python/python311._pth"
          @"
          python311.zip
          .
          Lib/site-packages
          import site
          "@ | Set-Content $pthFile -Encoding UTF8
          
          Write-Host "ğŸ“„ python311._pth å†…å®¹:"
          Get-Content $pthFile
          
          # ä¸‹è½½ get-pip.py
          Write-Host "ğŸ“¥ ä¸‹è½½ get-pip.py"
          Invoke-WebRequest -Uri "https://bootstrap.pypa.io/get-pip.py" -OutFile "vendor/windows/python/get-pip.py"
          
          # åˆ›å»º site-packages ç›®å½•
          New-Item -ItemType Directory -Force -Path "vendor/windows/python/Lib/site-packages"
          
          # å®‰è£… pip
          Write-Host "ğŸ”§ å®‰è£… pip"
          & "vendor/windows/python/python.exe" "vendor/windows/python/get-pip.py" --no-warn-script-location
          
          # å®‰è£…ä¾èµ–åˆ° site-packages
          Write-Host "ğŸ”§ å®‰è£… Python ä¾èµ–"
          & "vendor/windows/python/python.exe" -m pip install flask flask-cors pydub requests pysrt diff-match-patch --target "vendor/windows/python/Lib/site-packages" --no-warn-script-location
          
          # éªŒè¯ä¾èµ–å®‰è£…
          Write-Host "ğŸ” éªŒè¯ Flask å’Œ flask-cors å®‰è£…:"
          & "vendor/windows/python/python.exe" -c "import flask; from flask_cors import CORS; print('Flask version:', flask.__version__)"
          
          Write-Host "âœ… Python Embedded å®‰è£…å®Œæˆ"
          dir "vendor/windows/python"
          dir "vendor/windows/python/Lib/site-packages"
      
      - name: ğŸ“¥ ä¸‹è½½ FFmpeg (Windows)
        shell: pwsh
        run: |
          $ffmpegUrl = "https://github.com/BtbN/FFmpeg-Builds/releases/download/latest/ffmpeg-master-latest-win64-gpl.zip"
          $ffmpegZip = "ffmpeg.zip"
          
          Write-Host "ğŸ“¥ ä¸‹è½½ FFmpeg from $ffmpegUrl"
          Invoke-WebRequest -Uri $ffmpegUrl -OutFile $ffmpegZip
          
          # è§£å‹åˆ°ä¸´æ—¶ç›®å½•
          Expand-Archive -Path $ffmpegZip -DestinationPath "ffmpeg-temp" -Force
          
          # åˆ›å»ºç›®æ ‡ç›®å½•å¹¶ç§»åŠ¨æ–‡ä»¶
          New-Item -ItemType Directory -Force -Path "vendor/windows/ffmpeg/bin"
          
          # æ‰¾åˆ°è§£å‹åçš„ç›®å½•ï¼ˆåç§°å¯èƒ½åŒ…å«ç‰ˆæœ¬å·ï¼‰
          $extractedDir = Get-ChildItem -Path "ffmpeg-temp" -Directory | Select-Object -First 1
          Copy-Item "$($extractedDir.FullName)/bin/ffmpeg.exe" "vendor/windows/ffmpeg/bin/"
          Copy-Item "$($extractedDir.FullName)/bin/ffprobe.exe" "vendor/windows/ffmpeg/bin/"
          
          # æ¸…ç†
          Remove-Item $ffmpegZip
          Remove-Item -Recurse -Force "ffmpeg-temp"
          
          Write-Host "âœ… FFmpeg å®‰è£…å®Œæˆ"
          dir "vendor/windows/ffmpeg/bin"
      
      - name: ğŸ”§ å®‰è£… Node ä¾èµ–
        run: npm ci
      
      - name: ğŸ—ï¸ æ„å»ºå‰ç«¯
        run: npm run build
      
      - name: ğŸ“¦ æ‰“åŒ… Windows x64
        run: npx electron-builder --win --x64
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: ğŸ“¤ ä¸Šä¼  Windows äº§ç‰©
        uses: actions/upload-artifact@v4
        with:
          name: windows-builds
          path: |
            dist-electron/*.zip
            dist-electron/*.exe
          retention-days: 30

  # ==================== Linux æ‰“åŒ… ====================
  build-linux:
    name: ğŸ§ Linux (x64)
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
      
      - name: ğŸ“¦ è®¾ç½® Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      - name: ğŸ è®¾ç½® Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: ğŸ”§ å®‰è£… Python ä¾èµ–
        run: |
          pip install flask flask-cors pydub requests pysrt diff-match-patch
      
      - name: ğŸ“¥ ä¸‹è½½ FFmpeg (Linux)
        run: |
          mkdir -p vendor/linux/ffmpeg/bin
          
          # ä¸‹è½½é™æ€ç¼–è¯‘çš„ FFmpeg
          wget -q https://johnvansickle.com/ffmpeg/releases/ffmpeg-release-amd64-static.tar.xz
          tar -xf ffmpeg-release-amd64-static.tar.xz
          
          # æ‰¾åˆ°è§£å‹ç›®å½•å¹¶å¤åˆ¶
          FFMPEG_DIR=$(ls -d ffmpeg-*-amd64-static)
          cp "$FFMPEG_DIR/ffmpeg" vendor/linux/ffmpeg/bin/
          cp "$FFMPEG_DIR/ffprobe" vendor/linux/ffmpeg/bin/
          chmod +x vendor/linux/ffmpeg/bin/*
          
          # æ¸…ç†
          rm -rf ffmpeg-release-amd64-static.tar.xz "$FFMPEG_DIR"
          
          echo "âœ… FFmpeg å®‰è£…å®Œæˆ"
          ls -la vendor/linux/ffmpeg/bin/
      
      - name: ğŸ”§ å®‰è£… Node ä¾èµ–
        run: npm ci
      
      - name: ğŸ—ï¸ æ„å»ºå‰ç«¯
        run: npm run build
      
      - name: ğŸ“¦ æ‰“åŒ… Linux x64
        run: npx electron-builder --linux --x64
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: ğŸ“¤ ä¸Šä¼  Linux äº§ç‰©
        uses: actions/upload-artifact@v4
        with:
          name: linux-builds
          path: |
            dist-electron/*.AppImage
            dist-electron/*.deb
          retention-days: 30

  # ==================== åˆ›å»º Release ====================
  create-release:
    name: ğŸ“¢ åˆ›å»º GitHub Release
    needs: [build-mac, build-windows, build-linux]
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v')
    
    steps:
      - name: ğŸ“¥ ä¸‹è½½æ‰€æœ‰äº§ç‰©
        uses: actions/download-artifact@v4
        with:
          path: all-builds
          merge-multiple: true
      
      - name: ğŸ“‹ åˆ—å‡ºæ–‡ä»¶
        run: ls -la all-builds/
      
      - name: ğŸ‰ åˆ›å»º Release
        uses: softprops/action-gh-release@v1
        with:
          files: all-builds/*
          draft: true
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
